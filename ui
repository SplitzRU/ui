--[[
    OT UI Library
    A sleek, minimal Roblox UI library
    Black/grey/white palette with glass transparency
]]

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer

-- Animation presets
local TWEEN_FAST = TweenInfo.new(0.12, Enum.EasingStyle.Quint, Enum.EasingDirection.Out)
local TWEEN_SMOOTH = TweenInfo.new(0.25, Enum.EasingStyle.Quint, Enum.EasingDirection.Out)
local TWEEN_BOUNCE = TweenInfo.new(0.35, Enum.EasingStyle.Back, Enum.EasingDirection.Out)

-- Theme (dark only)
local Theme = {
    Background = Color3.fromRGB(18, 18, 18),
    Sidebar = Color3.fromRGB(18, 18, 18),
    TopBar = Color3.fromRGB(18, 18, 18),
    Section = Color3.fromRGB(22, 22, 22),
    Border = Color3.fromRGB(40, 40, 40),
    Text = Color3.fromRGB(200, 200, 200),
    TextDim = Color3.fromRGB(95, 95, 95),
    Accent = Color3.fromRGB(180, 180, 180),
    Toggle = Color3.fromRGB(45, 45, 45),
    ToggleOn = Color3.fromRGB(140, 140, 140),
    Input = Color3.fromRGB(30, 30, 30),
    Hover = Color3.fromRGB(35, 35, 35),
}

local Library = {}
Library.__index = Library

local CONFIG_FOLDER = "OTConfigs"

-- Helpers
local function Tween(obj, props, info)
    local tween = TweenService:Create(obj, info or TWEEN_SMOOTH, props)
    tween:Play()
    return tween
end

local function Corner(parent, radius)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, radius or 8)
    c.Parent = parent
    return c
end

local function Stroke(parent, color, thickness, transparency)
    local s = Instance.new("UIStroke")
    s.Color = color or Theme.Border
    s.Thickness = thickness or 1
    s.Transparency = transparency or 0
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    s.Parent = parent
    return s
end

local function Padding(parent, t, r, b, l)
    local p = Instance.new("UIPadding")
    p.PaddingTop = UDim.new(0, t or 0)
    p.PaddingRight = UDim.new(0, r or t or 0)
    p.PaddingBottom = UDim.new(0, b or t or 0)
    p.PaddingLeft = UDim.new(0, l or r or t or 0)
    p.Parent = parent
    return p
end

-- Config helpers
local function ensureFolder()
    if makefolder and isfolder and not isfolder(CONFIG_FOLDER) then
        makefolder(CONFIG_FOLDER)
    end
end

local function saveConfig(name, data)
    ensureFolder()
    if writefile then
        writefile(CONFIG_FOLDER .. "/" .. name .. ".json", HttpService:JSONEncode(data))
        return true
    end
    return false
end

local function loadConfig(name)
    if readfile and isfile and isfile(CONFIG_FOLDER .. "/" .. name .. ".json") then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile(CONFIG_FOLDER .. "/" .. name .. ".json"))
        end)
        if success then return data end
    end
    return nil
end

local function deleteConfig(name)
    if delfile and isfile and isfile(CONFIG_FOLDER .. "/" .. name .. ".json") then
        delfile(CONFIG_FOLDER .. "/" .. name .. ".json")
        return true
    end
    return false
end

local function listConfigs()
    local configs = {}
    if listfiles and isfolder and isfolder(CONFIG_FOLDER) then
        for _, file in ipairs(listfiles(CONFIG_FOLDER)) do
            local name = file:match("([^/\\]+)%.json$")
            if name and name ~= "_autoload" then table.insert(configs, name) end
        end
    end
    return configs
end

local function setAutoLoadConfig(name)
    ensureFolder()
    if writefile then
        writefile(CONFIG_FOLDER .. "/_autoload.txt", name or "")
        return true
    end
    return false
end

local function getAutoLoadConfig()
    if readfile and isfile and isfile(CONFIG_FOLDER .. "/_autoload.txt") then
        local name = readfile(CONFIG_FOLDER .. "/_autoload.txt")
        if name and name ~= "" then return name end
    end
    return nil
end

local function clearAutoLoadConfig()
    if delfile and isfile and isfile(CONFIG_FOLDER .. "/_autoload.txt") then
        delfile(CONFIG_FOLDER .. "/_autoload.txt")
        return true
    end
    return false
end

-- Main Library
function Library.new(title)
    local self = setmetatable({}, Library)
    
    local playerGui = player:WaitForChild("PlayerGui")
    
    -- Screen
    local screen = Instance.new("ScreenGui")
    screen.Name = "OTUI"
    screen.ResetOnSpawn = false
    screen.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screen.Parent = playerGui
    
    -- Shadow (equal on all sides)
    local shadow = Instance.new("ImageLabel")
    shadow.Name = "Shadow"
    shadow.Size = UDim2.new(0, 820, 0, 540)
    shadow.Position = UDim2.new(0.5, 0, 0.5, 0)  -- Centered, equal shadow all sides
    shadow.AnchorPoint = Vector2.new(0.5, 0.5)
    shadow.BackgroundTransparency = 1
    shadow.Image = "rbxassetid://6014261993"
    shadow.ImageColor3 = Color3.new(0, 0, 0)
    shadow.ImageTransparency = 0.5
    shadow.ScaleType = Enum.ScaleType.Slice
    shadow.SliceCenter = Rect.new(49, 49, 450, 450)
    shadow.ZIndex = 1
    shadow.Parent = screen
    
    -- Loading screen background
    local loadingBg = Instance.new("Frame")
    loadingBg.Name = "LoadingBg"
    loadingBg.Size = UDim2.new(0, 300, 0, 180)
    loadingBg.Position = UDim2.new(0.5, 0, 0.5, 0)
    loadingBg.AnchorPoint = Vector2.new(0.5, 0.5)
    loadingBg.BackgroundColor3 = Theme.Background
    loadingBg.BackgroundTransparency = 0.1
    loadingBg.BorderSizePixel = 0
    loadingBg.ZIndex = 10
    loadingBg.Parent = screen
    Corner(loadingBg, 12)
    Stroke(loadingBg, Theme.Border, 1, 0.5)
    
    -- Loading title
    local loadingTitle = Instance.new("TextLabel")
    loadingTitle.Size = UDim2.new(1, 0, 0, 30)
    loadingTitle.Position = UDim2.new(0, 0, 0, 20)
    loadingTitle.BackgroundTransparency = 1
    loadingTitle.Text = title or "OT"
    loadingTitle.TextColor3 = Theme.Text
    loadingTitle.TextSize = 18
    loadingTitle.Font = Enum.Font.GothamBold
    loadingTitle.ZIndex = 11
    loadingTitle.Parent = loadingBg
    
    -- Spinning circle
    local spinner = Instance.new("ImageLabel")
    spinner.Name = "Spinner"
    spinner.Size = UDim2.new(0, 40, 0, 40)
    spinner.Position = UDim2.new(0.5, 0, 0.5, -5)
    spinner.AnchorPoint = Vector2.new(0.5, 0.5)
    spinner.BackgroundTransparency = 1
    spinner.Image = "rbxassetid://6031091004"
    spinner.ImageColor3 = Theme.Accent
    spinner.ZIndex = 11
    spinner.Parent = loadingBg
    
    -- Loading status text (above progress bar)
    local loadingText = Instance.new("TextLabel")
    loadingText.Size = UDim2.new(1, 0, 0, 20)
    loadingText.Position = UDim2.new(0, 0, 1, -50)
    loadingText.BackgroundTransparency = 1
    loadingText.Text = "Initializing..."
    loadingText.TextColor3 = Theme.TextDim
    loadingText.TextSize = 12
    loadingText.Font = Enum.Font.Gotham
    loadingText.ZIndex = 11
    loadingText.Parent = loadingBg
    
    -- Progress bar background
    local progressBg = Instance.new("Frame")
    progressBg.Size = UDim2.new(0.8, 0, 0, 4)
    progressBg.Position = UDim2.new(0.1, 0, 1, -25)
    progressBg.BackgroundColor3 = Theme.Toggle
    progressBg.BorderSizePixel = 0
    progressBg.ZIndex = 11
    progressBg.Parent = loadingBg
    Corner(progressBg, 2)
    
    -- Progress bar fill
    local progressFill = Instance.new("Frame")
    progressFill.Size = UDim2.new(0, 0, 1, 0)
    progressFill.BackgroundColor3 = Theme.Accent
    progressFill.BorderSizePixel = 0
    progressFill.ZIndex = 12
    progressFill.Parent = progressBg
    Corner(progressFill, 2)
    
    -- Spin animation
    local spinConnection
    spinConnection = RunService.RenderStepped:Connect(function(dt)
        spinner.Rotation = spinner.Rotation + dt * 200
    end)
    
    -- Loading status messages
    local loadingStages = {
        {text = "Initializing...", progress = 0.1},
        {text = "Loading assets...", progress = 0.25},
        {text = "Setting up UI...", progress = 0.4},
        {text = "Loading configs...", progress = 0.6},
        {text = "Preparing components...", progress = 0.8},
        {text = "Almost ready...", progress = 0.95},
        {text = "Done!", progress = 1}
    }
    
    -- Main window (container only, no background)
    local window = Instance.new("Frame")
    window.Name = "Window"
    window.Size = UDim2.new(0, 780, 0, 500)
    window.Position = UDim2.new(0.5, 0, 0.5, 0)
    window.AnchorPoint = Vector2.new(0.5, 0.5)
    window.BackgroundTransparency = 1
    window.BorderSizePixel = 0
    window.ClipsDescendants = true
    window.ZIndex = 2
    window.Visible = false
    window.Parent = screen
    
    -- Top bar
    local topBar = Instance.new("Frame")
    topBar.Name = "TopBar"
    topBar.Size = UDim2.new(1, 0, 0, 36)
    topBar.Position = UDim2.new(0, 0, 0, 0)
    topBar.BackgroundColor3 = Theme.TopBar
    topBar.BackgroundTransparency = 0.1
    topBar.BorderSizePixel = 0
    topBar.Parent = window
    
    -- Title
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -100, 1, 0)
    titleLabel.Position = UDim2.new(0, 15, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = title or "OT"
    titleLabel.TextColor3 = Theme.Text
    titleLabel.TextSize = 14
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = topBar
    
    -- Close button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 36, 0, 36)
    closeBtn.Position = UDim2.new(1, -36, 0, 0)
    closeBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
    closeBtn.BackgroundTransparency = 1
    closeBtn.Text = "×"
    closeBtn.TextColor3 = Theme.TextDim
    closeBtn.TextSize = 20
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.BorderSizePixel = 0
    closeBtn.AutoButtonColor = false
    closeBtn.Parent = topBar
    
    closeBtn.MouseEnter:Connect(function()
        Tween(closeBtn, {BackgroundTransparency = 0, TextColor3 = Color3.new(1,1,1)}, TWEEN_FAST)
    end)
    closeBtn.MouseLeave:Connect(function()
        Tween(closeBtn, {BackgroundTransparency = 1, TextColor3 = Theme.TextDim}, TWEEN_FAST)
    end)
    closeBtn.MouseButton1Click:Connect(function()
        Tween(window, {Size = UDim2.new(0, 780, 0, 0)}, TWEEN_SMOOTH)
        Tween(shadow, {ImageTransparency = 1}, TWEEN_SMOOTH)
        task.delay(0.3, function() screen:Destroy() end)
    end)
    
    -- Minimize button
    local minBtn = Instance.new("TextButton")
    minBtn.Size = UDim2.new(0, 36, 0, 36)
    minBtn.Position = UDim2.new(1, -72, 0, 0)
    minBtn.BackgroundColor3 = Theme.Hover
    minBtn.BackgroundTransparency = 1
    minBtn.Text = "−"
    minBtn.TextColor3 = Theme.TextDim
    minBtn.TextSize = 20
    minBtn.Font = Enum.Font.GothamBold
    minBtn.BorderSizePixel = 0
    minBtn.AutoButtonColor = false
    minBtn.Parent = topBar
    
    local minimized = false
    local fullSize = UDim2.new(0, 780, 0, 500)
    
    minBtn.MouseEnter:Connect(function()
        Tween(minBtn, {BackgroundTransparency = 0, TextColor3 = Theme.Text}, TWEEN_FAST)
    end)
    minBtn.MouseLeave:Connect(function()
        Tween(minBtn, {BackgroundTransparency = 1, TextColor3 = Theme.TextDim}, TWEEN_FAST)
    end)
    minBtn.MouseButton1Click:Connect(function()
        minimized = not minimized
        if minimized then
            Tween(window, {Size = UDim2.new(0, 780, 0, 36)}, TWEEN_SMOOTH)
            Tween(shadow, {Size = UDim2.new(0, 820, 0, 80)}, TWEEN_SMOOTH)
        else
            Tween(window, {Size = fullSize}, TWEEN_SMOOTH)
            Tween(shadow, {Size = UDim2.new(0, 820, 0, 540)}, TWEEN_SMOOTH)
        end
    end)
    
    -- Sidebar (below top bar)
    local sidebar = Instance.new("Frame")
    sidebar.Name = "Sidebar"
    sidebar.Size = UDim2.new(0, 180, 1, -36)
    sidebar.Position = UDim2.new(0, 0, 0, 36)
    sidebar.BackgroundColor3 = Theme.Sidebar
    sidebar.BackgroundTransparency = 0.1
    sidebar.BorderSizePixel = 0
    sidebar.Parent = window
    
    -- User profile section
    local userSection = Instance.new("Frame")
    userSection.Size = UDim2.new(1, 0, 0, 70)
    userSection.BackgroundTransparency = 1
    userSection.Parent = sidebar
    
    -- Avatar circle (using thumbnail image)
    local avatarHolder = Instance.new("Frame")
    avatarHolder.Size = UDim2.new(0, 46, 0, 46)
    avatarHolder.Position = UDim2.new(0, 10, 0, 12)
    avatarHolder.BackgroundColor3 = Theme.Section
    avatarHolder.BorderSizePixel = 0
    avatarHolder.ClipsDescendants = true
    avatarHolder.Parent = userSection
    Corner(avatarHolder, 23)
    Stroke(avatarHolder, Theme.Border, 1, 0.5)
    
    -- Avatar image (headshot thumbnail)
    local avatarImage = Instance.new("ImageLabel")
    avatarImage.Name = "Avatar"
    avatarImage.Size = UDim2.new(1, 0, 1, 0)
    avatarImage.BackgroundTransparency = 1
    avatarImage.Parent = avatarHolder
    Corner(avatarImage, 23)
    
    -- Load avatar thumbnail async
    task.spawn(function()
        local success, content = pcall(function()
            return Players:GetUserThumbnailAsync(player.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size100x100)
        end)
        if success and content then
            avatarImage.Image = content
        end
    end)
    
    -- Username (moved more left)
    local usernameLabel = Instance.new("TextLabel")
    usernameLabel.Size = UDim2.new(1, -68, 0, 18)
    usernameLabel.Position = UDim2.new(0, 62, 0, 16)
    usernameLabel.BackgroundTransparency = 1
    usernameLabel.Text = player.DisplayName
    usernameLabel.TextColor3 = Theme.Text
    usernameLabel.TextSize = 13
    usernameLabel.Font = Enum.Font.GothamBold
    usernameLabel.TextXAlignment = Enum.TextXAlignment.Left
    usernameLabel.TextTruncate = Enum.TextTruncate.AtEnd
    usernameLabel.Parent = userSection
    
    -- @handle (moved more left)
    local handleLabel = Instance.new("TextLabel")
    handleLabel.Size = UDim2.new(1, -68, 0, 16)
    handleLabel.Position = UDim2.new(0, 62, 0, 35)
    handleLabel.BackgroundTransparency = 1
    handleLabel.Text = "@" .. player.Name
    handleLabel.TextColor3 = Theme.TextDim
    handleLabel.TextSize = 11
    handleLabel.Font = Enum.Font.Gotham
    handleLabel.TextXAlignment = Enum.TextXAlignment.Left
    handleLabel.TextTruncate = Enum.TextTruncate.AtEnd
    handleLabel.Parent = userSection
    
    -- Separator
    local separator = Instance.new("Frame")
    separator.Size = UDim2.new(1, -20, 0, 1)
    separator.Position = UDim2.new(0, 10, 1, -1)
    separator.BackgroundColor3 = Theme.Border
    separator.BackgroundTransparency = 0.6
    separator.BorderSizePixel = 0
    separator.Parent = userSection
    
    -- Tab holder
    local tabHolder = Instance.new("ScrollingFrame")
    tabHolder.Size = UDim2.new(1, -12, 1, -80)
    tabHolder.Position = UDim2.new(0, 6, 0, 75)
    tabHolder.BackgroundTransparency = 1
    tabHolder.BorderSizePixel = 0
    tabHolder.ScrollBarThickness = 0
    tabHolder.CanvasSize = UDim2.new(0, 0, 0, 0)
    tabHolder.AutomaticCanvasSize = Enum.AutomaticSize.Y
    tabHolder.Parent = sidebar
    
    local tabLayout = Instance.new("UIListLayout")
    tabLayout.Padding = UDim.new(0, 4)
    tabLayout.Parent = tabHolder
    
    -- Content area (below top bar, right of sidebar)
    local content = Instance.new("Frame")
    content.Name = "Content"
    content.Size = UDim2.new(1, -180, 1, -36)
    content.Position = UDim2.new(0, 180, 0, 36)
    content.BackgroundColor3 = Theme.Background
    content.BackgroundTransparency = 0.1
    content.BorderSizePixel = 0
    content.ClipsDescendants = true
    content.Parent = window
    
    -- Drag functionality (drag from top bar)
    local dragging, dragStart, startPos
    
    topBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = window.Position
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            local newPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            window.Position = newPos
            shadow.Position = UDim2.new(newPos.X.Scale, newPos.X.Offset, newPos.Y.Scale, newPos.Y.Offset)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    self._screen = screen
    self._window = window
    self._shadow = shadow
    self._sidebar = sidebar
    self._tabHolder = tabHolder
    self._content = content
    self._tabs = {}
    self._activeTab = nil
    self._toggleKey = Enum.KeyCode.LeftAlt
    self._visible = true
    self._configValues = {}
    self._configCallbacks = {}
    
    -- Toggle visibility
    UserInputService.InputBegan:Connect(function(input, processed)
        if not processed and input.KeyCode == self._toggleKey then
            self._visible = not self._visible
            screen.Enabled = self._visible
        end
    end)
    
    -- Intro animation with loading screen
    shadow.ImageTransparency = 1
    
    task.defer(function()
        -- Animate through loading stages
        for i, stage in ipairs(loadingStages) do
            loadingText.Text = stage.text
            Tween(progressFill, {Size = UDim2.new(stage.progress, 0, 1, 0)}, TweenInfo.new(0.2))
            task.wait(0.25)
        end
        
        task.wait(0.2)
        
        -- Fade out loading
        Tween(loadingBg, {BackgroundTransparency = 1}, TWEEN_SMOOTH)
        Tween(loadingTitle, {TextTransparency = 1}, TWEEN_SMOOTH)
        Tween(loadingText, {TextTransparency = 1}, TWEEN_SMOOTH)
        Tween(spinner, {ImageTransparency = 1}, TWEEN_SMOOTH)
        Tween(progressBg, {BackgroundTransparency = 1}, TWEEN_SMOOTH)
        Tween(progressFill, {BackgroundTransparency = 1}, TWEEN_SMOOTH)
        task.wait(0.3)
        
        -- Stop spinner and remove loading
        spinConnection:Disconnect()
        loadingBg:Destroy()
        
        -- Auto-load config if set
        local autoLoadName = getAutoLoadConfig()
        if autoLoadName then
            local data = loadConfig(autoLoadName)
            if data then
                for key, val in pairs(data) do
                    self._configValues[key] = val
                end
            end
        end
        
        -- Show main window with fade in
        window.Visible = true
        Tween(shadow, {ImageTransparency = 0.5}, TWEEN_SMOOTH)
        
        -- Fade in all UI elements (skip avatar)
        for _, child in pairs(window:GetDescendants()) do
            if child:IsA("Frame") or child:IsA("TextLabel") or child:IsA("TextButton") or child:IsA("TextBox") or child:IsA("ScrollingFrame") then
                local originalBgTrans = child.BackgroundTransparency
                
                if originalBgTrans < 1 then
                    child.BackgroundTransparency = 1
                    Tween(child, {BackgroundTransparency = originalBgTrans}, TWEEN_SMOOTH)
                end
                if child:IsA("TextLabel") or child:IsA("TextButton") or child:IsA("TextBox") then
                    child.TextTransparency = 1
                    Tween(child, {TextTransparency = 0}, TWEEN_SMOOTH)
                end
            elseif child:IsA("ImageLabel") and child.Name ~= "Avatar" then
                local originalTrans = child.ImageTransparency
                if originalTrans < 1 then
                    child.ImageTransparency = 1
                    Tween(child, {ImageTransparency = originalTrans}, TWEEN_SMOOTH)
                end
            end
        end
        
        -- Apply auto-loaded config callbacks after UI is visible
        if autoLoadName then
            for key, val in pairs(self._configValues) do
                if self._configCallbacks[key] then
                    pcall(self._configCallbacks[key], val)
                end
            end
        end
    end)
    
    return self
end

function Library:SetToggleKey(keyCode)
    self._toggleKey = keyCode
end

function Library:SaveConfig(name)
    return saveConfig(name, self._configValues)
end

function Library:LoadConfig(name)
    local data = loadConfig(name)
    if data then
        for key, val in pairs(data) do
            self._configValues[key] = val
            if self._configCallbacks[key] then
                pcall(self._configCallbacks[key], val)
            end
        end
        return true
    end
    return false
end

function Library:DeleteConfig(name)
    return deleteConfig(name)
end

function Library:GetConfigs()
    return listConfigs()
end

function Library:AddTab(name)
    local tabBtn = Instance.new("TextButton")
    tabBtn.Name = "Tab_" .. name
    tabBtn.Size = UDim2.new(1, -8, 0, 36)
    tabBtn.BackgroundColor3 = Theme.Section
    tabBtn.BackgroundTransparency = 1
    tabBtn.Text = name
    tabBtn.TextColor3 = Theme.TextDim
    tabBtn.TextSize = 13
    tabBtn.Font = Enum.Font.GothamMedium
    tabBtn.BorderSizePixel = 0
    tabBtn.AutoButtonColor = false
    tabBtn.Parent = self._tabHolder
    Corner(tabBtn, 6)
    
    -- Indicator
    local indicator = Instance.new("Frame")
    indicator.Size = UDim2.new(0, 3, 0, 0)
    indicator.Position = UDim2.new(0, 0, 0.5, 0)
    indicator.AnchorPoint = Vector2.new(0, 0.5)
    indicator.BackgroundColor3 = Theme.Accent
    indicator.BorderSizePixel = 0
    indicator.Parent = tabBtn
    Corner(indicator, 2)
    
    -- Tab content
    local tabContent = Instance.new("ScrollingFrame")
    tabContent.Name = name
    tabContent.Size = UDim2.new(1, 0, 1, 0)
    tabContent.BackgroundTransparency = 1
    tabContent.BorderSizePixel = 0
    tabContent.ScrollBarThickness = 3
    tabContent.ScrollBarImageColor3 = Theme.TextDim
    tabContent.ScrollBarImageTransparency = 0.5
    tabContent.CanvasSize = UDim2.new(0, 0, 0, 0)
    tabContent.AutomaticCanvasSize = Enum.AutomaticSize.Y
    tabContent.Visible = false
    tabContent.Parent = self._content
    
    -- Vertical layout for rows of sections
    local contentLayout = Instance.new("UIListLayout")
    contentLayout.Padding = UDim.new(0, 8)
    contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
    contentLayout.FillDirection = Enum.FillDirection.Vertical
    contentLayout.Parent = tabContent
    
    Padding(tabContent, 10, 10, 10, 10)
    
    local tab = {
        Button = tabBtn,
        Content = tabContent,
        Name = name,
        _window = self,
        _layoutOrder = 0,
        _currentSection = nil,
        _currentRow = nil,
        _rowSectionCount = 0
    }
    
    local function selectTab()
        for _, t in pairs(self._tabs) do
            t.Content.Visible = false
            Tween(t.Button, {BackgroundTransparency = 1, TextColor3 = Theme.TextDim}, TWEEN_FAST)
            local ind = t.Button:FindFirstChild("Frame")
            if ind then Tween(ind, {Size = UDim2.new(0, 3, 0, 0)}, TWEEN_FAST) end
        end
        tabContent.Visible = true
        self._activeTab = tab
        Tween(tabBtn, {BackgroundTransparency = 0.1, TextColor3 = Theme.Text}, TWEEN_FAST)
        Tween(indicator, {Size = UDim2.new(0, 3, 0, 20)}, TWEEN_SMOOTH)
    end
    
    tabBtn.MouseButton1Click:Connect(selectTab)
    
    tabBtn.MouseEnter:Connect(function()
        if self._activeTab ~= tab then
            Tween(tabBtn, {BackgroundTransparency = 0.1}, TWEEN_FAST)
        end
    end)
    tabBtn.MouseLeave:Connect(function()
        if self._activeTab ~= tab then
            Tween(tabBtn, {BackgroundTransparency = 1}, TWEEN_FAST)
        end
    end)
    
    table.insert(self._tabs, tab)
    
    if #self._tabs == 1 then
        selectTab()
    end
    
    setmetatable(tab, {__index = Library})
    tab._currentContent = tabContent
    tab._library = self
    
    return tab
end

function Library:_getNextOrder()
    self._layoutOrder = (self._layoutOrder or 0) + 1
    return self._layoutOrder
end

-- Section creates a container box (side by side, 2 per row)
function Library:AddSection(title)
    -- Check if we need a new row (every 2 sections)
    if not self._currentRow or self._rowSectionCount >= 2 then
        -- Create new row
        local row = Instance.new("Frame")
        row.Name = "Row"
        row.Size = UDim2.new(1, 0, 0, 0)
        row.AutomaticSize = Enum.AutomaticSize.Y
        row.BackgroundTransparency = 1
        row.LayoutOrder = self:_getNextOrder()
        row.Parent = self._currentContent
        
        local rowLayout = Instance.new("UIListLayout")
        rowLayout.Padding = UDim.new(0, 12)
        rowLayout.FillDirection = Enum.FillDirection.Horizontal
        rowLayout.SortOrder = Enum.SortOrder.LayoutOrder
        rowLayout.Parent = row
        
        self._currentRow = row
        self._rowSectionCount = 0
    end
    
    self._rowSectionCount = self._rowSectionCount + 1
    
    local sectionFrame = Instance.new("Frame")
    sectionFrame.Name = "Section_" .. title
    sectionFrame.Size = UDim2.new(0.5, -6, 0, 0) -- Half width minus half gap
    sectionFrame.AutomaticSize = Enum.AutomaticSize.Y
    sectionFrame.BackgroundColor3 = Theme.Section
    sectionFrame.BackgroundTransparency = 0.1
    sectionFrame.BorderSizePixel = 0
    sectionFrame.LayoutOrder = self._rowSectionCount
    sectionFrame.Parent = self._currentRow
    Corner(sectionFrame, 10)
    Stroke(sectionFrame, Theme.Border, 1, 0.6)
    
    -- Section title
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, 0, 0, 32)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = title
    titleLabel.TextColor3 = Theme.TextDim
    titleLabel.TextSize = 11
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = sectionFrame
    Padding(titleLabel, 0, 0, 0, 14)
    
    -- Items container inside section
    local itemsHolder = Instance.new("Frame")
    itemsHolder.Name = "Items"
    itemsHolder.Size = UDim2.new(1, 0, 0, 0)
    itemsHolder.AutomaticSize = Enum.AutomaticSize.Y
    itemsHolder.Position = UDim2.new(0, 0, 0, 28)
    itemsHolder.BackgroundTransparency = 1
    itemsHolder.Parent = sectionFrame
    
    local itemsLayout = Instance.new("UIListLayout")
    itemsLayout.Padding = UDim.new(0, 0)
    itemsLayout.SortOrder = Enum.SortOrder.LayoutOrder
    itemsLayout.Parent = itemsHolder
    
    Padding(itemsHolder, 0, 14, 10, 14)
    
    -- Store current section for components to use
    self._currentSection = itemsHolder
    self._sectionFrame = sectionFrame
    self._sectionOrder = 0
    
    return sectionFrame
end

function Library:_getSectionOrder()
    self._sectionOrder = (self._sectionOrder or 0) + 1
    return self._sectionOrder
end

-- Simple toggle (inside section)
function Library:AddToggle(options)
    local parent = self._currentSection or self._currentContent
    local configKey = options.ConfigKey or options.Name
    
    local frame = Instance.new("Frame")
    frame.Name = "Toggle"
    frame.Size = UDim2.new(1, 0, 0, 38)
    frame.BackgroundTransparency = 1
    frame.LayoutOrder = self:_getSectionOrder()
    frame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -50, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = options.Name or "Toggle"
    label.TextColor3 = Theme.Text
    label.TextSize = 13
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    -- Toggle switch
    local toggleBg = Instance.new("TextButton")
    toggleBg.Size = UDim2.new(0, 38, 0, 20)
    toggleBg.Position = UDim2.new(1, 0, 0.5, 0)
    toggleBg.AnchorPoint = Vector2.new(1, 0.5)
    toggleBg.BackgroundColor3 = Theme.Toggle
    toggleBg.BackgroundTransparency = 0.1
    toggleBg.Text = ""
    toggleBg.BorderSizePixel = 0
    toggleBg.AutoButtonColor = false
    toggleBg.Parent = frame
    Corner(toggleBg, 10)
    
    local knob = Instance.new("Frame")
    knob.Size = UDim2.new(0, 16, 0, 16)
    knob.Position = UDim2.new(0, 2, 0.5, 0)
    knob.AnchorPoint = Vector2.new(0, 0.5)
    knob.BackgroundColor3 = Color3.fromRGB(130, 130, 130)
    knob.BorderSizePixel = 0
    knob.Parent = toggleBg
    Corner(knob, 8)
    
    local state = options.Default or false
    
    local function updateVisual()
        if state then
            Tween(toggleBg, {BackgroundColor3 = Theme.ToggleOn}, TWEEN_SMOOTH)
            Tween(knob, {Position = UDim2.new(1, -18, 0.5, 0), BackgroundColor3 = Theme.Section}, TWEEN_SMOOTH)
        else
            Tween(toggleBg, {BackgroundColor3 = Theme.Toggle}, TWEEN_SMOOTH)
            Tween(knob, {Position = UDim2.new(0, 2, 0.5, 0), BackgroundColor3 = Color3.fromRGB(130, 130, 130)}, TWEEN_SMOOTH)
        end
    end
    
    local function setState(val, skipCallback)
        state = val
        updateVisual()
        if self._library then
            self._library._configValues[configKey] = state
        end
        if not skipCallback and options.Callback then
            options.Callback(state)
        end
    end
    
    toggleBg.MouseButton1Click:Connect(function()
        setState(not state)
    end)
    
    updateVisual()
    
    if self._library then
        self._library._configCallbacks[configKey] = function(val)
            setState(val, true)
        end
        self._library._configValues[configKey] = state
    end
    
    return {
        Frame = frame,
        Set = function(_, val) setState(val) end,
        Get = function() return state end
    }
end

-- Simple slider (inside section) with editable value
function Library:AddSlider(options)
    local parent = self._currentSection or self._currentContent
    local configKey = options.ConfigKey or options.Name
    local min = options.Min or 0
    local max = options.Max or 100
    local default = options.Default or min
    local value = default
    
    local frame = Instance.new("Frame")
    frame.Name = "Slider"
    frame.Size = UDim2.new(1, 0, 0, 38)
    frame.BackgroundTransparency = 1
    frame.LayoutOrder = self:_getSectionOrder()
    frame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.35, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = options.Name or "Slider"
    label.TextColor3 = Theme.Text
    label.TextSize = 13
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    -- Editable value input (clickable) - on far right
    local valueBox = Instance.new("TextBox")
    valueBox.Size = UDim2.new(0, 45, 0, 22)
    valueBox.Position = UDim2.new(1, 0, 0.5, 0)
    valueBox.AnchorPoint = Vector2.new(1, 0.5)
    valueBox.BackgroundColor3 = Theme.Input
    valueBox.BackgroundTransparency = 0.1
    valueBox.Text = tostring(value)
    valueBox.TextColor3 = Theme.Text
    valueBox.TextSize = 11
    valueBox.Font = Enum.Font.Gotham
    valueBox.BorderSizePixel = 0
    valueBox.ClearTextOnFocus = true
    valueBox.Parent = frame
    Corner(valueBox, 4)
    
    -- Track (between label and value box, close to value)
    local track = Instance.new("Frame")
    track.Size = UDim2.new(0.65, -60, 0, 6)  -- Long track, small gap before value
    track.Position = UDim2.new(0.35, 0, 0.5, 0)
    track.AnchorPoint = Vector2.new(0, 0.5)
    track.BackgroundColor3 = Theme.Toggle
    track.BackgroundTransparency = 0.1
    track.BorderSizePixel = 0
    track.Parent = frame
    Corner(track, 3)
    
    -- Knob
    local knob = Instance.new("Frame")
    knob.Size = UDim2.new(0, 14, 0, 14)
    knob.Position = UDim2.new((value - min) / (max - min), 0, 0.5, 0)
    knob.AnchorPoint = Vector2.new(0.5, 0.5)
    knob.BackgroundColor3 = Theme.Accent
    knob.BorderSizePixel = 0
    knob.Parent = track
    Corner(knob, 7)
    
    local sliding = false
    
    local function setValue(val, skipCallback)
        value = math.clamp(math.floor(val + 0.5), min, max)
        local pos = (value - min) / (max - min)
        valueBox.Text = tostring(value)
        Tween(knob, {Position = UDim2.new(pos, 0, 0.5, 0)}, TWEEN_FAST)
        if self._library then
            self._library._configValues[configKey] = value
        end
        if not skipCallback and options.Callback then
            options.Callback(value)
        end
    end
    
    -- Value box input
    valueBox.FocusLost:Connect(function(enter)
        local num = tonumber(valueBox.Text)
        if num then
            setValue(num)
        else
            valueBox.Text = tostring(value)
        end
    end)
    
    local function update(input)
        local pos = math.clamp((input.Position.X - track.AbsolutePosition.X) / track.AbsoluteSize.X, 0, 1)
        setValue(min + (max - min) * pos)
    end
    
    track.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            sliding = true
            update(input)
        end
    end)
    
    knob.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            sliding = true
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if sliding and input.UserInputType == Enum.UserInputType.MouseMovement then
            update(input)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            sliding = false
        end
    end)
    
    if self._library then
        self._library._configCallbacks[configKey] = function(val)
            setValue(val, true)
        end
        self._library._configValues[configKey] = value
    end
    
    return {
        Frame = frame,
        Set = function(_, val) setValue(val) end,
        Get = function() return value end
    }
end

-- Simple button (inside section)
function Library:AddButton(options)
    local parent = self._currentSection or self._currentContent
    
    local frame = Instance.new("Frame")
    frame.Name = "Button"
    frame.Size = UDim2.new(1, 0, 0, 38)
    frame.BackgroundTransparency = 1
    frame.LayoutOrder = self:_getSectionOrder()
    frame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -60, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = options.Name or "Button"
    label.TextColor3 = Theme.Text
    label.TextSize = 13
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    -- Small circle button on right
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 24, 0, 24)
    btn.Position = UDim2.new(1, 0, 0.5, 0)
    btn.AnchorPoint = Vector2.new(1, 0.5)
    btn.BackgroundColor3 = Theme.Toggle
    btn.BackgroundTransparency = 0.1
    btn.Text = ""
    btn.BorderSizePixel = 0
    btn.AutoButtonColor = false
    btn.Parent = frame
    Corner(btn, 12)
    Stroke(btn, Theme.Border, 1, 0.5)
    
    -- Inner dot
    local dot = Instance.new("Frame")
    dot.Size = UDim2.new(0, 8, 0, 8)
    dot.Position = UDim2.new(0.5, 0, 0.5, 0)
    dot.AnchorPoint = Vector2.new(0.5, 0.5)
    dot.BackgroundColor3 = Theme.Accent
    dot.BorderSizePixel = 0
    dot.Parent = btn
    Corner(dot, 4)
    
    btn.MouseEnter:Connect(function()
        Tween(btn, {BackgroundColor3 = Theme.Hover}, TWEEN_FAST)
    end)
    btn.MouseLeave:Connect(function()
        Tween(btn, {BackgroundColor3 = Theme.Toggle}, TWEEN_FAST)
    end)
    
    btn.MouseButton1Click:Connect(function()
        -- Click animation
        Tween(dot, {Size = UDim2.new(0, 12, 0, 12)}, TWEEN_FAST)
        task.delay(0.1, function()
            Tween(dot, {Size = UDim2.new(0, 8, 0, 8)}, TWEEN_FAST)
        end)
        if options.Callback then
            options.Callback()
        end
    end)
    
    return frame
end

-- Simple dropdown (inside section) - expands to push content down
function Library:AddDropdown(options)
    local parent = self._currentSection or self._currentContent
    local configKey = options.ConfigKey or options.Name
    local selected = options.Default
    local open = false
    local closedHeight = 38
    local optionsHeight = #(options.Options or {}) * 28 + 10
    
    local frame = Instance.new("Frame")
    frame.Name = "Dropdown"
    frame.Size = UDim2.new(1, 0, 0, closedHeight)
    frame.BackgroundTransparency = 1
    frame.ClipsDescendants = true
    frame.LayoutOrder = self:_getSectionOrder()
    frame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.45, 0, 0, 38)
    label.BackgroundTransparency = 1
    label.Text = options.Name or "Dropdown"
    label.TextColor3 = Theme.Text
    label.TextSize = 13
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    -- Dropdown button
    local dropBtn = Instance.new("TextButton")
    dropBtn.Size = UDim2.new(0.52, 0, 0, 28)
    dropBtn.Position = UDim2.new(0.48, 0, 0, 5)
    dropBtn.BackgroundColor3 = Theme.Input
    dropBtn.BackgroundTransparency = 0.1
    dropBtn.Text = ""
    dropBtn.BorderSizePixel = 0
    dropBtn.AutoButtonColor = false
    dropBtn.Parent = frame
    Corner(dropBtn, 6)
    Stroke(dropBtn, Theme.Border, 1, 0.6)
    
    local selectedLabel = Instance.new("TextLabel")
    selectedLabel.Size = UDim2.new(1, -30, 1, 0)
    selectedLabel.Position = UDim2.new(0, 10, 0, 0)
    selectedLabel.BackgroundTransparency = 1
    selectedLabel.Text = selected or "Select..."
    selectedLabel.TextColor3 = Theme.Text
    selectedLabel.TextSize = 12
    selectedLabel.Font = Enum.Font.Gotham
    selectedLabel.TextXAlignment = Enum.TextXAlignment.Left
    selectedLabel.TextTruncate = Enum.TextTruncate.AtEnd
    selectedLabel.Parent = dropBtn
    
    local arrow = Instance.new("TextLabel")
    arrow.Size = UDim2.new(0, 20, 1, 0)
    arrow.Position = UDim2.new(1, -22, 0, 0)
    arrow.BackgroundTransparency = 1
    arrow.Text = "▼"
    arrow.TextColor3 = Theme.TextDim
    arrow.TextSize = 8
    arrow.Font = Enum.Font.Gotham
    arrow.Parent = dropBtn
    
    -- Options container (inside frame, below header)
    local optionsFrame = Instance.new("Frame")
    optionsFrame.Size = UDim2.new(1, 0, 0, 0)
    optionsFrame.Position = UDim2.new(0, 0, 0, closedHeight)
    optionsFrame.BackgroundColor3 = Theme.Input
    optionsFrame.BackgroundTransparency = 1
    optionsFrame.BorderSizePixel = 0
    optionsFrame.Parent = frame
    
    local optionsLayout = Instance.new("UIListLayout")
    optionsLayout.Padding = UDim.new(0, 2)
    optionsLayout.Parent = optionsFrame
    
    local function createOption(opt)
        local optBtn = Instance.new("TextButton")
        optBtn.Size = UDim2.new(1, 0, 0, 26)
        optBtn.BackgroundColor3 = Theme.Input
        optBtn.BackgroundTransparency = 0.1
        optBtn.Text = opt
        optBtn.TextColor3 = Theme.Text
        optBtn.TextSize = 12
        optBtn.Font = Enum.Font.Gotham
        optBtn.BorderSizePixel = 0
        optBtn.AutoButtonColor = false
        optBtn.Parent = optionsFrame
        Corner(optBtn, 4)
        
        optBtn.MouseEnter:Connect(function()
            Tween(optBtn, {BackgroundColor3 = Theme.Hover}, TWEEN_FAST)
        end)
        optBtn.MouseLeave:Connect(function()
            Tween(optBtn, {BackgroundColor3 = Theme.Input}, TWEEN_FAST)
        end)
        
        optBtn.MouseButton1Click:Connect(function()
            selected = opt
            selectedLabel.Text = opt
            if self._library then
                self._library._configValues[configKey] = selected
            end
            open = false
            -- Collapse frame to push content back up
            Tween(frame, {Size = UDim2.new(1, 0, 0, closedHeight)}, TWEEN_FAST)
            Tween(arrow, {Rotation = 0}, TWEEN_FAST)
            if options.Callback then
                options.Callback(opt)
            end
        end)
    end
    
    for _, opt in ipairs(options.Options or {}) do
        createOption(opt)
    end
    
    dropBtn.MouseButton1Click:Connect(function()
        open = not open
        if open then
            -- Expand frame to show options (pushes content down)
            Tween(frame, {Size = UDim2.new(1, 0, 0, closedHeight + optionsHeight)}, TWEEN_FAST)
            Tween(arrow, {Rotation = 180}, TWEEN_FAST)
        else
            -- Collapse frame
            Tween(frame, {Size = UDim2.new(1, 0, 0, closedHeight)}, TWEEN_FAST)
            Tween(arrow, {Rotation = 0}, TWEEN_FAST)
        end
    end)
    
    if self._library then
        self._library._configCallbacks[configKey] = function(val)
            selected = val
            selectedLabel.Text = val
        end
        if selected then
            self._library._configValues[configKey] = selected
        end
    end
    
    return {
        Frame = frame,
        Set = function(_, val)
            selected = val
            selectedLabel.Text = val
        end,
        Get = function() return selected end,
        Refresh = function(newOptions)
            -- Clear existing options
            for _, child in pairs(optionsFrame:GetChildren()) do
                if child:IsA("TextButton") then child:Destroy() end
            end
            -- Add new options
            for _, opt in ipairs(newOptions or {}) do
                createOption(opt)
            end
            optionsHeight = #(newOptions or {}) * 28 + 10
        end
    }
end

-- Simple keybind (inside section)
function Library:AddKeybind(options)
    local parent = self._currentSection or self._currentContent
    local configKey = options.ConfigKey or options.Name
    local key = options.Default
    local listening = false
    
    local frame = Instance.new("Frame")
    frame.Name = "Keybind"
    frame.Size = UDim2.new(1, 0, 0, 38)
    frame.BackgroundTransparency = 1
    frame.LayoutOrder = self:_getSectionOrder()
    frame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -70, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = options.Name or "Keybind"
    label.TextColor3 = Theme.Text
    label.TextSize = 13
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local keyBtn = Instance.new("TextButton")
    keyBtn.Size = UDim2.new(0, 55, 0, 24)
    keyBtn.Position = UDim2.new(1, 0, 0.5, 0)
    keyBtn.AnchorPoint = Vector2.new(1, 0.5)
    keyBtn.BackgroundColor3 = Theme.Input
    keyBtn.BackgroundTransparency = 0.1
    keyBtn.Text = key and key.Name or "None"
    keyBtn.TextColor3 = Theme.Text
    keyBtn.TextSize = 11
    keyBtn.Font = Enum.Font.Gotham
    keyBtn.BorderSizePixel = 0
    keyBtn.AutoButtonColor = false
    keyBtn.Parent = frame
    Corner(keyBtn, 4)
    Stroke(keyBtn, Theme.Border, 1, 0.6)
    
    local function setKey(k, skipCallback)
        key = k
        keyBtn.Text = k and k.Name or "None"
        if self._library then
            self._library._configValues[configKey] = k and k.Name or nil
        end
        if not skipCallback and options.Callback then
            options.Callback(k)
        end
    end
    
    keyBtn.MouseButton1Click:Connect(function()
        listening = true
        keyBtn.Text = "..."
    end)
    
    UserInputService.InputBegan:Connect(function(input, processed)
        if listening then
            listening = false
            if input.UserInputType == Enum.UserInputType.Keyboard then
                setKey(input.KeyCode)
            else
                setKey(nil)
            end
        end
    end)
    
    if self._library then
        self._library._configCallbacks[configKey] = function(val)
            if val then
                setKey(Enum.KeyCode[val], true)
            else
                setKey(nil, true)
            end
        end
        if key then
            self._library._configValues[configKey] = key.Name
        end
    end
    
    return {
        Frame = frame,
        Set = function(_, k) setKey(k) end,
        Get = function() return key end
    }
end

-- Simple textbox (inside section)
function Library:AddTextbox(options)
    local parent = self._currentSection or self._currentContent
    local configKey = options.ConfigKey or options.Name
    
    local frame = Instance.new("Frame")
    frame.Name = "Textbox"
    frame.Size = UDim2.new(1, 0, 0, 38)
    frame.BackgroundTransparency = 1
    frame.LayoutOrder = self:_getSectionOrder()
    frame.Parent = parent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0.35, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = options.Name or "Input"
    label.TextColor3 = Theme.Text
    label.TextSize = 13
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame
    
    local inputBox = Instance.new("TextBox")
    inputBox.Size = UDim2.new(0.62, 0, 0, 26)
    inputBox.Position = UDim2.new(0.38, 0, 0.5, 0)
    inputBox.AnchorPoint = Vector2.new(0, 0.5)
    inputBox.BackgroundColor3 = Theme.Input
    inputBox.BackgroundTransparency = 0.1
    inputBox.Text = options.Default or ""
    inputBox.PlaceholderText = options.Placeholder or "Type..."
    inputBox.PlaceholderColor3 = Theme.TextDim
    inputBox.TextColor3 = Theme.Text
    inputBox.TextSize = 12
    inputBox.Font = Enum.Font.Gotham
    inputBox.BorderSizePixel = 0
    inputBox.ClearTextOnFocus = false
    inputBox.Parent = frame
    Corner(inputBox, 4)
    Stroke(inputBox, Theme.Border, 1, 0.6)
    Padding(inputBox, 0, 8, 0, 8)
    
    inputBox.FocusLost:Connect(function()
        if self._library then
            self._library._configValues[configKey] = inputBox.Text
        end
        if options.Callback then
            options.Callback(inputBox.Text)
        end
    end)
    
    if self._library then
        self._library._configCallbacks[configKey] = function(val)
            inputBox.Text = val or ""
        end
        self._library._configValues[configKey] = inputBox.Text
    end
    
    return {
        Frame = frame,
        Set = function(_, text) inputBox.Text = text end,
        Get = function() return inputBox.Text end
    }
end

-- Label
function Library:AddLabel(text)
    local parent = self._currentSection or self._currentContent
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0, 28)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Theme.TextDim
    label.TextSize = 12
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.LayoutOrder = self:_getSectionOrder()
    label.Parent = parent
    
    return {
        Label = label,
        Set = function(_, newText) label.Text = newText end
    }
end

-- Settings tab
function Library:SettingsTab()
    local settings = self:AddTab("Settings")
    
    settings:AddSection("Configurations")
    
    local configName = ""
    settings:AddTextbox({
        Name = "Config Name",
        Placeholder = "Enter name...",
        Callback = function(text)
            configName = text
        end
    })
    
    -- Auto-refreshing config dropdown
    local configList
    local function refreshConfigs()
        local configs = self:GetConfigs()
        if configList and configList.Refresh then
            configList.Refresh(configs)
        end
        return configs
    end
    
    configList = settings:AddDropdown({
        Name = "Configs",
        Options = refreshConfigs(),
        Default = nil
    })
    
    settings:AddButton({
        Name = "Save Config",
        Callback = function()
            if configName ~= "" then
                self:SaveConfig(configName)
                refreshConfigs()
            end
        end
    })
    
    settings:AddButton({
        Name = "Load Config",
        Callback = function()
            local sel = configList.Get()
            if sel then
                self:LoadConfig(sel)
            end
        end
    })
    
    settings:AddButton({
        Name = "Delete Config",
        Callback = function()
            local sel = configList.Get()
            if sel then
                self:DeleteConfig(sel)
                refreshConfigs()
            end
        end
    })
    
    -- Auto load in same section
    local autoLoadLabel = settings:AddLabel("Auto Load: " .. (getAutoLoadConfig() or "None"))
    
    settings:AddButton({
        Name = "Set Auto Load",
        Callback = function()
            local sel = configList.Get()
            if sel then
                setAutoLoadConfig(sel)
                autoLoadLabel.Set(nil, "Auto Load: " .. sel)
            end
        end
    })
    
    settings:AddButton({
        Name = "Clear Auto Load",
        Callback = function()
            clearAutoLoadConfig()
            autoLoadLabel.Set(nil, "Auto Load: None")
        end
    })
    
    settings:AddSection("UI Toggle")
    settings:AddKeybind({
        Name = "Toggle Key",
        Default = Enum.KeyCode.LeftAlt,
        Callback = function(key)
            self._toggleKey = key
        end
    })
    
    return settings
end

return Library
